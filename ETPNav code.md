# ETPNav code















cur_pos, cur_ori = self.get_pos_ori()

```
            # get vp_id, vp_pos of cur_node and cand_ndoe
            cur_pos, cur_ori = self.get_pos_ori()
            cur_vp, cand_vp, cand_pos = [], [], []
            for i in range(self.envs.num_envs):
                cur_vp_i, cand_vp_i, cand_pos_i = self.gmaps[i].identify_node(
                    cur_pos[i], cur_ori[i], wp_outputs['cand_angles'][i], wp_outputs['cand_distances'][i]
                )
                cur_vp.append(cur_vp_i)
                cand_vp.append(cand_vp_i)
                cand_pos.append(cand_pos_i)
```



```
            for i in range(self.envs.num_envs):
                cur_embeds = avg_pano_embeds[i]
                cand_embeds = pano_embeds[i][vp_inputs['nav_types'][i]==1]
                self.gmaps[i].update_graph(prev_vp[i], stepk+1,
                                           cur_vp[i], cur_pos[i], cur_embeds,
                                           cand_vp[i], cand_pos[i], cand_embeds,
                                           cand_real_pos[i])
```

opencv-python==3.4.0.12









```
            # cand waypoint prediction
            wp_outputs = self.policy.net(
                mode = "waypoint",
                waypoint_predictor = self.waypoint_predictor,
                observations = batch,
                in_train = (mode == 'train' and self.config.IL.waypoint_aug),
            )
```

output

```
wp_outputs = {

		# 预测的vp对应12张图像中具体的某一张的特征值
		'cand_rgb': [tensor([[ 0.4565, -0.1201, -0.0604,  ...,  0.1533,  0.2795, -0.1414],
        [ 0.4253,  0.1252, -0.1227,  ...,  0.0377,  0.1798, -0.2129],
        [ 0.1852,  0.1316, -0.3091,  ...,  0.0356, -0.0719, -0.0492],
        [ 0.1852,  0.1316, -0.3091,  ...,  0.0356, -0.0719, -0.0492],
        [ 0.0651,  0.2356,  0.0348,  ...,  0.0422, -0.1354,  0.1548]],
       device='cuda:0')], 
       
       'cand_depth': [tensor([[0.0180, 0.1103, 0.1280, 0.1287, 0.1148, 0.0535, 0.0307, 0.2213, 0.1024,
         0.1529, 0.1500, 0.0862, 0.0567, 0.1914, 0.1186, 0.1108, 0.0728, 0.0914,
         0.1802, 0.1781, 0.0545, 0.0274, 0.0889, 0.0618, 0.1195, 0.1245, 0.0342,
         0.1610, 0.1128, 0.0150, 0.1072, 0.0810, 0.1308, 0.1601, 0.0985, 0.1358,
         0.0483, 0.1879, 0.0274, 0.1028, 0.2006, 0.1360, 0.1032, 0.1181, 0.1052,
         0.0408, 0.1236, 0.1243, 0.1490, 0.1132, 0.0000, 0.0208, 0.2757, 0.0914,
         0.1661, 0.0468, 0.1659, 0.2747, 0.0801, 0.2418, 0.0329, 0.0888, 0.0496,
         0.1233, 0.2634, 0.1452, 0.2452, 0.1809, 0.0245, 0.0758, 0.1608, 0.3262,
         0.0638, 0.0995, 0.0647, 0.1040, 0.2847, 0.2068, 0.0786, 0.2425, 0.2373,
         0.2791, 0.0839, 0.0966, 0.1786, 0.0921, 0.1979, 0.1468, 0.0930, 0.1086,
         0.0000, 0.1724, 0.1126, 0.0909, 0.0569, 0.0926, 0.1397, 0.2606, 0.0363,
         0.3276, 0.0974, 0.2286, 0.0986, 0.2425, 0.0399, 0.1038, 0.0948, 0.2259,
         0.1494, 0.2607, 0.2014, 0.1971, 0.1492, 0.0396, 0.1316, 0.0350, 0.0740,
         0.0871, 0.1885, 0.0118, 0.0451, 0.2663, 0.0320, 0.1500, 0.2724, 0.0902,
         0.2380, 0.0335],
        [0.0958, 0.0619, 0.0980, 0.1830, 0.1817, 0.0996, 0.0870, 0.2261, 0.0014,
         0.1018, 0.0915, 0.0022, 0.1051, 0.1428, 0.0439, 0.1542, 0.0497, 0.2268,
         0.0892, 0.1476, 0.1500, 0.1046, 0.0226, 0.1800, 0.1143, 0.0086, 0.0632,
         0.1109, 0.2207, 0.1436, 0.1530, 0.2028, 0.2007, 0.1878, 0.0855, 0.1367,
         0.0290, 0.1240, 0.0568, 0.1247, 0.1828, 0.1466, 0.0305, 0.1108, 0.1296,
         0.1462, 0.2103, 0.0573, 0.3733, 0.0923, 0.0000, 0.0074, 0.2776, 0.0986,
         0.2120, 0.1332, 0.1454, 0.1017, 0.1691, 0.1785, 0.0823, 0.1913, 0.0288,
         0.0965, 0.3439, 0.2375, 0.1002, 0.0062, 0.0290, 0.1188, 0.1543, 0.2513,
         0.0775, 0.0902, 0.0123, 0.0319, 0.1042, 0.1425, 0.0866, 0.1786, 0.2204,
         0.1493, 0.2216, 0.0405, 0.3031, 0.1400, 0.1828, 0.0798, 0.0759, 0.1414,
         0.0553, 0.1579, 0.1891, 0.0717, 0.0461, 0.2264, 0.0414, 0.1394, 0.0260,
         0.1144, 0.1055, 0.1974, 0.0700, 0.0574, 0.0313, 0.0608, 0.0497, 0.1752,
         0.0146, 0.1376, 0.2212, 0.0939, 0.0654, 0.0909, 0.1369, 0.2350, 0.0745,
         0.1399, 0.3412, 0.0608, 0.1120, 0.2195, 0.0444, 0.2194, 0.1560, 0.0169,
         0.1789, 0.1221],
        [0.1475, 0.2069, 0.1937, 0.1831, 0.0294, 0.0000, 0.0552, 0.0743, 0.1622,
         0.1656, 0.0396, 0.1627, 0.2696, 0.0914, 0.1626, 0.0902, 0.0745, 0.0537,
         0.1267, 0.1035, 0.1060, 0.2884, 0.2368, 0.1168, 0.0998, 0.0161, 0.1196,
         0.2226, 0.2014, 0.0000, 0.1197, 0.0913, 0.2238, 0.0356, 0.0737, 0.1223,
         0.0306, 0.1152, 0.2926, 0.0654, 0.0639, 0.2788, 0.0260, 0.1844, 0.0317,
         0.2773, 0.3134, 0.1168, 0.1107, 0.1669, 0.0544, 0.1440, 0.2665, 0.0044,
         0.1454, 0.1484, 0.1279, 0.1441, 0.1046, 0.1088, 0.0000, 0.2029, 0.2214,
         0.1571, 0.1023, 0.2793, 0.2068, 0.0668, 0.0153, 0.1943, 0.0101, 0.1865,
         0.0510, 0.1662, 0.5914, 0.1164, 0.0081, 0.3277, 0.2505, 0.1032, 0.4313,
         0.0802, 0.0803, 0.0656, 0.0104, 0.3050, 0.0483, 0.1297, 0.1048, 0.0820,
         0.3758, 0.0354, 0.0702, 0.0555, 0.1516, 0.2318, 0.0581, 0.0586, 0.0823,
         0.1765, 0.1164, 0.0451, 0.4252, 0.0832, 0.1026, 0.1996, 0.1065, 0.1677,
         0.2182, 0.2302, 0.0480, 0.0502, 0.1192, 0.0334, 0.0781, 0.0505, 0.0023,
         0.0133, 0.2617, 0.0081, 0.0493, 0.0984, 0.0712, 0.1145, 0.0686, 0.0247,
         0.1312, 0.1348],
        [0.1475, 0.2069, 0.1937, 0.1831, 0.0294, 0.0000, 0.0552, 0.0743, 0.1622,
         0.1656, 0.0396, 0.1627, 0.2696, 0.0914, 0.1626, 0.0902, 0.0745, 0.0537,
         0.1267, 0.1035, 0.1060, 0.2884, 0.2368, 0.1168, 0.0998, 0.0161, 0.1196,
         0.2226, 0.2014, 0.0000, 0.1197, 0.0913, 0.2238, 0.0356, 0.0737, 0.1223,
         0.0306, 0.1152, 0.2926, 0.0654, 0.0639, 0.2788, 0.0260, 0.1844, 0.0317,
         0.2773, 0.3134, 0.1168, 0.1107, 0.1669, 0.0544, 0.1440, 0.2665, 0.0044,
         0.1454, 0.1484, 0.1279, 0.1441, 0.1046, 0.1088, 0.0000, 0.2029, 0.2214,
         0.1571, 0.1023, 0.2793, 0.2068, 0.0668, 0.0153, 0.1943, 0.0101, 0.1865,
         0.0510, 0.1662, 0.5914, 0.1164, 0.0081, 0.3277, 0.2505, 0.1032, 0.4313,
         0.0802, 0.0803, 0.0656, 0.0104, 0.3050, 0.0483, 0.1297, 0.1048, 0.0820,
         0.3758, 0.0354, 0.0702, 0.0555, 0.1516, 0.2318, 0.0581, 0.0586, 0.0823,
         0.1765, 0.1164, 0.0451, 0.4252, 0.0832, 0.1026, 0.1996, 0.1065, 0.1677,
         0.2182, 0.2302, 0.0480, 0.0502, 0.1192, 0.0334, 0.0781, 0.0505, 0.0023,
         0.0133, 0.2617, 0.0081, 0.0493, 0.0984, 0.0712, 0.1145, 0.0686, 0.0247,
         0.1312, 0.1348],
        [0.0000, 0.2259, 0.2376, 0.1934, 0.1744, 0.0313, 0.1786, 0.1189, 0.0000,
         0.1083, 0.0284, 0.0858, 0.3484, 0.0886, 0.1576, 0.0966, 0.0942, 0.0954,
         0.0080, 0.0557, 0.1243, 0.1869, 0.1144, 0.3333, 0.0877, 0.1434, 0.1488,
         0.2788, 0.2908, 0.0340, 0.1365, 0.0169, 0.2190, 0.1541, 0.0379, 0.2025,
         0.0094, 0.2534, 0.1363, 0.1771, 0.0052, 0.3454, 0.0884, 0.0862, 0.0289,
         0.3050, 0.3173, 0.0681, 0.1495, 0.1698, 0.0482, 0.0929, 0.2664, 0.1106,
         0.0807, 0.1255, 0.1706, 0.1474, 0.0688, 0.1893, 0.1357, 0.2239, 0.0634,
         0.0647, 0.1662, 0.1700, 0.0799, 0.0443, 0.1119, 0.1698, 0.0213, 0.1061,
         0.0130, 0.0342, 0.3184, 0.1260, 0.0823, 0.2638, 0.1530, 0.1522, 0.4405,
         0.1864, 0.1816, 0.0908, 0.0834, 0.3767, 0.1934, 0.1961, 0.0472, 0.2541,
         0.3058, 0.0220, 0.0547, 0.0714, 0.1533, 0.2031, 0.1789, 0.0347, 0.0723,
         0.1396, 0.1182, 0.0562, 0.2012, 0.0882, 0.0545, 0.1256, 0.1211, 0.1133,
         0.0849, 0.0755, 0.1431, 0.0956, 0.0343, 0.0361, 0.0463, 0.0701, 0.0788,
         0.1081, 0.0930, 0.0620, 0.0479, 0.0494, 0.0476, 0.1628, 0.0407, 0.0175,
         0.0788, 0.2877]], device='cuda:0')], 
         
         # cand_angle抽出来的特征
         'cand_angle_fts': [tensor([[ 0.9945, -0.1045,  0.0000,  1.0000],
        [ 0.9135, -0.4067,  0.0000,  1.0000],
        [-0.9781, -0.2079,  0.0000,  1.0000],
        [-0.9986,  0.0523,  0.0000,  1.0000],
        [-0.8660,  0.5000,  0.0000,  1.0000]])], 
        
        # 逆时针
        'cand_img_idxes': [array([9, 8, 3, 3, 2])], 
        'cand_angles': [[...]], 
        'cand_distances': [[...]], 
        
        # pano_rgb = rgb_feats      B x 12 x 2048
        'pano_rgb': tensor([[[ 0.2020, -0.0856, -0.2024,  ...,  0.3657, -0.3386,  0.2454],
         [ 0.1261,  0.1304, -0.1183,  ...,  0.3499, -0.0396,  0.2900],
         [ 0.0651,  0.2356,  0.0348,  ...,  0.0422, -0.1354,  0.1548],
         ...,
         [ 0.4565, -0.1201, -0.0604,  ...,  0.1533,  0.2795, -0.1414],
         [ 0.6055, -0.2620, -0.1034,  ...,  0.0936, -0.0564,  0.0747],
         [ 0.3137,  0.0663, -0.2578,  ...,  0.5703, -0.2109, -0.0618]]],
       device='cuda:0'), 
       
       # pano_depth = depth_feats         B x 12 x 128
       'pano_depth': tensor([[[0.0352, 0.0488, 0.1649,  ..., 0.1064, 0.2192, 0.0843],
         [0.0122, 0.1324, 0.2334,  ..., 0.0180, 0.0861, 0.1544],
         [0.0000, 0.2259, 0.2376,  ..., 0.0175, 0.0788, 0.2877],
         ...,
         [0.0180, 0.1103, 0.1280,  ..., 0.0902, 0.2380, 0.0335],
         [0.0406, 0.1008, 0.1228,  ..., 0.0636, 0.3035, 0.0030],
         [0.1126, 0.0401, 0.0678,  ..., 0.0361, 0.1821, 0.0590]]],
       device='cuda:0'), 
       
       # 对应于12张图像切法的角度信息抽特征
       'pano_angle_fts': tensor([[-2.4493e-16,  1.0000e+00,  0.0000e+00,  1.0000e+00],
        [-5.0000e-01,  8.6603e-01,  0.0000e+00,  1.0000e+00],
        [-8.6603e-01,  5.0000e-01,  0.0000e+00,  1.0000e+00],
        [-1.0000e+00, -1.8370e-16,  0.0000e+00,  1.0000e+00],
        [-8.6603e-01, -5.0000e-01,  0.0000e+00,  1.0000e+00],
        [-5.0000e-01, -8.6603e-01,  0.0000e+00,  1.0000e+00],
        [ 1.2246e-16, -1.0000e+00,  0.0000e+00,  1.0000e+00],
        [ 5.0000e-01, -8.6603e-01,  0.0000e+00,  1.0000e+00],
        [ 8.6603e-01, -5.0000e-01,  0.0000e+00,  1.0000e+00],
        [ 1.0000e+00,  6.1232e-17,  0.0000e+00,  1.0000e+00],
        [ 8.6603e-01,  5.0000e-01,  0.0000e+00,  1.0000e+00],
        [ 5.0000e-01,  8.6603e-01,  0.0000e+00,  1.0000e+00]]), 
        
        'pano_img_idxes': array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11])}
```





```
            # get vp_id, vp_pos of cur_node and cand_ndoe
            cur_pos, cur_ori = self.get_pos_ori()
```

```
    def get_pos_ori(self):
        pos_ori = self.envs.call(['get_pos_ori']*self.envs.num_envs)
        pos = [x[0] for x in pos_ori]
        ori = [x[1] for x in pos_ori]
        return pos, ori

```

